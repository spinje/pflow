# Workflow Discovery Issue Analysis & Fix

## Problem Identified

The workflow discovery system is failing to match queries because **rich metadata generated by the MetadataGenerationNode is not being included in the discovery context**.

### Root Causes

1. **WorkflowManager.save() ignores metadata in IR**
   - The save method only uses the optional `description` parameter
   - It doesn't extract metadata from the workflow IR's `metadata` field
   - Result: Rich metadata is lost when saving

2. **Discovery context only shows basic info**
   - `_format_discovery_workflows()` only looks for `workflow["description"]`
   - It doesn't include keywords, capabilities, or use cases from rich metadata
   - Result: LLM makes decisions based only on workflow name

### Evidence from Debug Script

- ✅ Metadata generation works: Keywords like `['changelog', 'release notes', 'version history']`
- ✅ Workflow saving works: File gets created successfully
- ❌ Discovery context missing metadata: Only shows `### github-issue-changelog-generator (workflow)`
- ❌ LLM can't match: "create release notes" fails because "release notes" keyword not visible

### Test Results

- Success rate: 4/6 queries (66.7%)
- Only succeeds when query terms appear in workflow name
- Fails when query terms only appear in keywords/metadata

## Required Fixes

### Fix 1: WorkflowManager.save() should preserve IR metadata

```python
# In WorkflowManager.save(), after creating the metadata wrapper:
metadata = {
    "name": name,
    "description": description or "",
    "ir": workflow_ir,
    "created_at": now,
    "updated_at": now,
    "version": "1.0.0",
}

# ADD: Extract metadata from IR if present
if "metadata" in workflow_ir:
    # Use metadata description if no explicit description provided
    if not description and "description" in workflow_ir["metadata"]:
        metadata["description"] = workflow_ir["metadata"]["description"]

    # Store the rich metadata for discovery
    metadata["rich_metadata"] = workflow_ir["metadata"]
```

### Fix 2: Discovery context should include rich metadata

```python
def _format_discovery_workflows(filtered_workflows: list[dict[str, Any]]) -> list[str]:
    """Format workflows section for discovery context."""
    markdown_sections = []

    if filtered_workflows:
        markdown_sections.append("## Available Workflows\n")
        for workflow in sorted(filtered_workflows, key=lambda w: w["name"]):
            markdown_sections.append(f"### {workflow['name']} (workflow)")

            # Get description from rich metadata or fallback to basic description
            description = ""
            if "rich_metadata" in workflow and "description" in workflow["rich_metadata"]:
                description = workflow["rich_metadata"]["description"]
            elif workflow.get("description", "").strip():
                description = workflow["description"].strip()

            if description:
                markdown_sections.append(description)

            # ADD: Include search keywords for better matching
            if "rich_metadata" in workflow and "search_keywords" in workflow["rich_metadata"]:
                keywords = workflow["rich_metadata"]["search_keywords"]
                if keywords:
                    markdown_sections.append(f"Keywords: {', '.join(keywords)}")

            # ADD: Include capabilities
            if "rich_metadata" in workflow and "capabilities" in workflow["rich_metadata"]:
                capabilities = workflow["rich_metadata"]["capabilities"]
                if capabilities:
                    markdown_sections.append("Capabilities:")
                    for capability in capabilities:
                        markdown_sections.append(f"- {capability}")

            markdown_sections.append("")  # Empty line

    return markdown_sections
```

## Expected Impact

After these fixes:
- ✅ "generate changelog" should still work (95% confidence)
- ✅ "create release notes" should now work (keywords: "release notes")
- ✅ "summarize closed issues" should still work (description mentions this)
- ✅ "version history from github" should work better (keywords: "version history")
- ❌ "sprint summary report" should still fail (correctly - workflow doesn't do sprints)

Expected success rate: 5/6 queries (83.3%)