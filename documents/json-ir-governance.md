# JSON IR Governance

This document defines the JSON Intermediate Representation (IR) schema, validation rules, and evolution governance for pflow. It focuses purely on IR structure and does not duplicate architectural concepts covered in other specifications.

> **Architecture Reference**: For understanding of shared store patterns, proxy mappings, and node interfaces, see [Shared Store + Proxy Design Pattern](./shared-store-node-proxy-architecture.md)

---

## 1 · Document Envelope

```json
{
  "$schema": "https://pflow.dev/schemas/flow-0.1.json",
  "ir_version": "0.1.0",
  "metadata": {
    "created": "2025-01-01T12:00:00Z",
    "description": "YouTube video summary pipeline",
    "planner_version": "1.0.0",
    "locked_nodes": {
      "core/yt-transcript": "1.0.0",
      "core/summarize-text": "2.1.0"
    }
  },
  "nodes": [...],
  "edges": [...],
  "mappings": {...}
}
```

**Field Requirements:**
- `$schema` dereferences a JSON-Schema; hard error if not recognised
- `ir_version` uses semantic versioning; unknown higher major → refuse to run
- `metadata.locked_nodes` mirrors [version lockfile](./node-discovery-namespacing-and-versioning.md) for deterministic execution
- `metadata.planner_version` tracks planner that generated IR for provenance

---

## 2 · Node Object

```json
{
  "id": "fetch-transcript",
  "version": "1.0.0",
  "params": {
    "language": "en",
    "timeout": 30
  },
  "execution": {
    "max_retries": 2,
    "use_cache": true,
    "wait": 1.0
  }
}
```

**Field Specifications:**

| Field | Rules | Notes |
|---|---|---|
| `id` | Unique token, `[A-Za-z0-9_-]{1,64}` | Flow-scoped identifier |
| `version` | Semantic version string | Resolved during [planner validation](./planner-responsibility-functionality-spec.md) |
| `params` | Arbitrary JSON for node behavior | **Never** contains shared store keys or execution directives |
| `execution.max_retries` | Integer ≥ 0, only for `@flow_safe` nodes | See [Runtime Behavior](./runtime-behavior-specification.md) |
| `execution.use_cache` | Boolean, only for `@flow_safe` nodes | Cache eligibility enforced at runtime |
| `execution.wait` | Float ≥ 0, retry delay in seconds | Used by [pocketflow framework](../pocketflow/__init__.py) |

**Interface Declaration:**
Nodes declare their natural shared store interface through docstring metadata, not IR params. See [shared store specification](./shared-store-node-proxy-architecture.md) for natural interface patterns.

---

## 3 · Edge Object

**Basic Transitions:**
```json
{"from": "fetch-transcript", "to": "create-summary"}
```

**Action-Based Transitions:**
```json
[
  {"from": "validator", "to": "processor"},
  {"from": "validator", "to": "error-handler", "action": "fail"},
  {"from": "processor", "to": "validator", "action": "continue"},
  {"from": "processor", "to": "finalizer"}
]
```

**Rules:**
- DAG must be acyclic; validator enforces
- Default transitions omit `"action"` field
- Named actions enable conditional flow control
- All declared actions must have defined transitions

> **Flow Structure**: See [planner specification](./planner-responsibility-functionality-spec.md) for action-based transition generation

---

## 4 · Proxy Mapping Schema

**Optional Flow-Level Mappings:**
```json
{
  "mappings": {
    "summarize-text": {
      "input_mappings": {"text": "raw_transcript"},
      "output_mappings": {"summary": "article_summary"}  
    },
    "store-result": {
      "input_mappings": {"content": "article_summary"}
    }
  }
}
```

**Mapping Purpose:**
- Enable complex flow routing while preserving natural node interfaces
- Generated by planner for marketplace compatibility scenarios
- Completely optional - nodes use direct shared store access when no mappings defined
- Transparent to node code via `NodeAwareSharedStore` proxy

> **Architecture Integration**: See [shared store pattern](./shared-store-node-proxy-architecture.md) for proxy implementation details

---

## 5 · Side-Effect Model

Node purity status determined by `@flow_safe` decorator (see [Runtime Behavior Specification](./runtime-behavior-specification.md)). IR validation enforces purity constraints:

- Only `@flow_safe` nodes may specify `max_retries > 0`
- Only `@flow_safe` nodes may specify `use_cache: true`
- Purity status read from node manifest; IR does not repeat it
- Validation occurs during [planner pipeline](./planner-responsibility-functionality-spec.md)

---

## 6 · Failure Semantics

**Retry Configuration:**
- Absence of `execution.max_retries` → `0` retries (fail fast)
- Flow aborts on first un-retried failure with status `FAILED`
- Retry configuration integrates with [pocketflow framework](../pocketflow/__init__.py) patterns

**Failure Logging:**
- Engine records `failure_trace` array in run log
- IR itself remains immutable during execution
- Complete failure context preserved for debugging

> **Runtime Integration**: See [runtime specification](./runtime-behavior-specification.md) for complete failure handling

---

## 7 · Caching Contract

IR enables caching through `execution.use_cache` field with validation rules:

- Only `@flow_safe` nodes may specify `use_cache: true`
- Cache eligibility determined at runtime by multiple factors
- IR validation occurs during planner pipeline
- Cache bypass (`--reset-cache`) is runtime flag, does not mutate IR

> **Implementation Details**: See [Runtime Behavior Specification](./runtime-behavior-specification.md) for cache key computation and storage

---

## 8 · Validation Pipeline

**Enhanced Validation Steps:**

1. **JSON Structure**: Parse → strict no-comments
2. **Schema Validation**: `$schema` + `ir_version` compatibility check  
3. **Registry Resolution**: Node identifier resolution against [registry](./node-discovery-namespacing-and-versioning.md)
4. **Graph Analysis**: Cycle detection including action-based transition paths
5. **Node Validation**: `params` schema validation from node manifest
6. **Interface Compatibility**: Natural interface alignment between connected nodes
7. **Proxy Mapping**: Validation of mapping definitions when present
8. **Purity Constraints**: `@flow_safe` requirement for `max_retries` and `use_cache`
9. **Framework Compatibility**: [pocketflow](../pocketflow/__init__.py) execution pattern validation

Flow failing any step is rejected before execution with comprehensive diagnostics.

> **Planner Integration**: Validation occurs during [planner responsibility phases](./planner-responsibility-functionality-spec.md)

---

## 9 · Evolution Rules

**Version Compatibility:**
- **Minor IR additions**: New optional fields allowed; unknown optional fields ignored but preserved
- **Major IR bump**: Engine refuses to run; user must upgrade `pflow`  
- **Deprecation Process**: Features flagged two minor versions before removal

**Extension Compatibility:**
- Forward compatibility for new mapping types
- Action-based transition extensions
- Execution configuration additions

---

## 10 · Extension Points

**Planned Extensions:**
- `execution.timeout` for node execution limits
- `constraints` object for resource caps (CPU, memory, disk)
- `annotations` free-form metadata for GUI/tooling integration
- Advanced mapping patterns for nested shared store keys
- Conditional execution based on shared store state

**Extension Principles:**
- Maintain backward compatibility
- Optional fields with sensible defaults
- Clear validation rules for new features

---

## 11 · Complete Example Flow

```json
{
  "$schema": "https://pflow.dev/schemas/flow-0.1.json", 
  "ir_version": "0.1.0",
  "metadata": {
    "created": "2025-01-01T12:00:00Z",
    "description": "YouTube video summary with error handling",
    "planner_version": "1.0.0",
    "locked_nodes": {
      "core/yt-transcript": "1.0.0",
      "core/summarize-text": "2.1.0",
      "core/error-handler": "1.0.0"
    }
  },
  "nodes": [
    {
      "id": "fetch-transcript",
      "version": "1.0.0", 
      "params": {"language": "en"},
      "execution": {"max_retries": 2, "wait": 1.0}
    },
    {
      "id": "create-summary",
      "version": "2.1.0",
      "params": {"temperature": 0.7, "max_tokens": 150},
      "execution": {"use_cache": true}
    },
    {
      "id": "handle-error",
      "version": "1.0.0",
      "params": {"fallback_message": "Video unavailable"}
    }
  ],
  "edges": [
    {"from": "fetch-transcript", "to": "create-summary"},
    {"from": "fetch-transcript", "to": "handle-error", "action": "video_unavailable"}
  ],
  "mappings": {
    "create-summary": {
      "input_mappings": {"text": "transcript"}
    }
  }
}
```

**Example Features:**
- Natural interface compatibility (`shared["transcript"]` → `shared["text"]` via mapping)
- Action-based error handling (`video_unavailable` action)
- Proper execution configuration for retry and caching
- Version locking for reproducibility

---

## 12 · Integration References

This IR schema integrates with pflow's complete architecture:

- **Shared Store Pattern**: [Natural interfaces and proxy mappings](./shared-store-node-proxy-architecture.md)
- **Planner Validation**: [Dual-mode operation and IR generation](./planner-responsibility-functionality-spec.md)  
- **CLI Resolution**: [Parameter injection and override rules](./shared-store-cli-runtime-specification.md)
- **Node Registry**: [Versioning and discovery](./node-discovery-namespacing-and-versioning.md)
- **Runtime Behavior**: [Caching, retry, and side-effect management](./runtime-behavior-specification.md)
- **Framework Integration**: [pocketflow execution patterns](../pocketflow/__init__.py)

---

This governance document ensures IR structure aligns with pflow's established architecture while providing a focused schema definition for JSON IR validation, evolution, and tooling integration.