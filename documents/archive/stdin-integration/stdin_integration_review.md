# Review of `shell-pipe-native-integration.md` Consistency

This document evaluates the consistency of `shell-pipe-native-integration.md` (referred to as SPI) with the other core `pflow` design documents.

## Overall Assessment

The `shell-pipe-native-integration.md` document generally aligns well with the core principles of `pflow`, such as explicitness, reproducibility, and leveraging the shared store. However, there is **one key area of potential contradiction** regarding the default handling of piped `stdin` content that needs clarification to ensure consistency across all documentation. Other aspects of `stdin` integration, like explicit mapping, NL planner support, and trace/caching, appear consistent.

## Key Findings

### 1. Default Handling of Piped `stdin` Content

*   **Potential Contradiction**:
    *   **SPI states**:
        *   Under "Basic Usage": "Automatically map the piped content to the primary string parameter (`--text`) of the first node."
        *   Under "Internal Implementation" -> "Mapping Logic": "Automatically maps to the first eligible, non-required string-type parameter."
    *   **Contradicting Information from Core Documents**:
        *   `PRD-pflow.md` (Section 5.2, Resolution Examples): `echo "content" | pflow summarize-text` results in `shared["stdin"] = "content"`.
        *   `shared-store-cli-runtime-specification.md` (Section 8, CLI Scenarios): `cat notes.txt | pflow summarise-text` results in `{ "stdin": "<bytes>" }`.
        *   `shared-store-cli-runtime-specification.md` (Section 11, Validation Rules, Rule 5): "`stdin` key reserved; node must handle it naturally."
        *   `planner-responsibility-functionality-spec.md` (Section 8.4, Shared Store Schema Design): "Reserved Keys: `stdin` for piped input".

*   **Analysis**:
    The core documents consistently indicate that when input is piped to `pflow`, the content is placed into the `shared` store under the **reserved key `stdin`**.
    The statements in SPI suggest that the piped content would instead directly populate a shared store key corresponding to the first node's primary input parameter (e.g., `shared["text"]` if `--text` is the primary parameter). These are two different mechanisms for where the piped data initially lands in the shared store.

    If the `shared["stdin"]` mechanism is the source of truth (as indicated by multiple foundational documents like the PRD and CLI Runtime Spec), then any "mapping" to a node's specific named input key (e.g., `text`) must be a secondary step:
    1.  The node itself is designed to read from `shared["stdin"]` if its primary input key is not found.
    2.  The IR, generated by the planner or CLI parser, includes an explicit mapping (e.g., `{"mappings": {"<node-id>": {"input_mappings": {"<node_param_key>": "stdin"}}}}`).
    The SPI's phrasing "Automatically map" implies a direct population of the parameter-named key, which bypasses the `shared["stdin"]` key as the initial recipient.

*   **Recommendation**:
    Clarify `shell-pipe-native-integration.md` to align with the `shared["stdin"]` key being the primary recipient of piped data. The "automatic mapping to the primary string parameter" could be rephrased to explain how nodes are expected to consume `shared["stdin"]` or how the planner/IR generation might set up mappings from `shared["stdin"]` to a node's specific input key. The current phrasing can be misleading.

### 2. Explicit Mapping of `stdin` using `-`

*   **Consistency Check**:
    *   **SPI states**: "For nodes with multiple string inputs or ambiguity: `git diff | pflow summarize-diff --diff -`. The `-` explicitly indicates the node should consume piped input."
    *   **Core Documents**: The "Type flags; engine decides" rule (`PRD-pflow.md`, Section 5.2; `shared-store-cli-runtime-specification.md`, Section 7) is the primary mechanism for CLI argument resolution. If `--diff` is a recognized natural interface key for the `summarize-diff` node, then `--diff -` would mean that `shared["diff"]` should be populated with the content from `stdin`.

*   **Analysis**:
    This appears consistent. The `-` token acts as a placeholder indicating that the value for the `--diff` flag (which translates to `shared["diff"]`) should be taken from the piped `stdin` content (which is primarily in `shared["stdin"]`). This aligns with the CLI resolution mechanism.

### 3. Natural Language Planner Support for Piped Input

*   **Consistency Check**:
    *   **SPI states**: "Natural language planner seamlessly supports piped input...mapping piped `stdin` into the workflow automatically."
    *   **Core Documents** (`planner-responsibility-functionality-spec.md`): The planner's role is to generate a validated JSON IR. If `stdin` is detected, the planner would need to be aware that `shared["stdin"]` will be populated and generate an IR where the first relevant node either naturally consumes `shared["stdin"]` or has an explicit mapping from its input key to `shared["stdin"]`.

*   **Analysis**:
    This is consistent. The planner's awareness of `stdin` and its ability to generate appropriate IR (including mappings if necessary) fits within its responsibilities.

### 4. Tracing and Caching of Piped Input

*   **Consistency Check**:
    *   **SPI states**: "Input is hashed, saved under `stdin.<hash>.txt`, and the hash is included in the trace and lockfile to ensure caching and reproducibility."
    *   **Core Documents** (`runtime-behavior-specification.md`, `PRD-pflow.md`): Caching relies on hashing all relevant input data. If `shared["stdin"]` contains the piped input and is used by a node, its content hash will naturally be part of the node's cache key calculation. Saving the content to a file like `stdin.<hash>.txt` is a plausible implementation detail for managing and referencing this data, especially for traces.

*   **Analysis**:
    This is consistent with the general caching and reproducibility principles of `pflow`. Hashing `stdin` is crucial.

## Conclusion

The integration of shell pipes is a valuable feature for `pflow`. To ensure clarity and consistency across all documentation, it is recommended to revise the description of the *default* handling of piped input in `shell-pipe-native-integration.md` to clearly state that `shared["stdin"]` is the key populated with the piped content. Any subsequent use of this content by a node's specific named input parameter should be explained as either a node's capability to read from `shared["stdin"]` or an explicit mapping in the IR. 