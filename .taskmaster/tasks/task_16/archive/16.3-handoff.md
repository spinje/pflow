# Handoff Memo: Task 16.3 - Add Category Organization and Format Optimization

**TO THE IMPLEMENTING AGENT**: Read this entire memo before starting. When done, acknowledge you're ready to begin - DO NOT start implementing immediately.

## ðŸš¨ Critical Context: Most of 16.3 is Already Done Too!

**ANOTHER SURPRISE**: Just like 16.2, most of 16.3 is already implemented. The pattern continues - the comprehensive 16.1 implementation covered most of the task's requirements.

## What's Already Implemented

Look at `/Users/andfal/projects/pflow/src/pflow/planning/context_builder.py`:

### 1. âœ… Category Organization (lines 103-124)

```python
def _group_nodes_by_category(nodes: dict[str, dict]) -> dict[str, list[str]]:
    """Group nodes by category based on simple pattern matching."""
    categories: dict[str, list[str]] = {}

    for node_type in nodes:
        # Simple pattern matching for categories
        if "file" in node_type or "read" in node_type or "write" in node_type:
            category = "File Operations"
        elif "llm" in node_type or "ai" in node_type:
            category = "AI/LLM Operations"
        elif "git" in node_type or "github" in node_type or "gitlab" in node_type:
            category = "Git Operations"
        elif "http" in node_type or "api" in node_type:
            category = "HTTP/API Operations"
        else:
            category = "General Operations"
```

### 2. âœ… Category-Based Output (lines 68-74)

```python
for category, nodes in sorted(categories.items()):
    markdown_sections.append(f"## {category}\n")

    for node_type in sorted(nodes):
        node_data = processed_nodes[node_type]
        section = _format_node_section(node_type, node_data)
        markdown_sections.append(section)
```

### 3. âœ… Size Monitoring (lines 85-88)

```python
output_size = len(output)
if output_size > 10000:  # 10KB warning threshold
    logger.warning(f"context: Large output size: {output_size} bytes")
```

### 4. âœ… Clear Markdown Format (lines 116-160)

The format already matches planner.md examples:
```markdown
## File Operations

### read-file
Read content from a file and add line numbers for display.

**Inputs**: `file_path`, `encoding`
**Outputs**: `content`, `error` (error)
**Parameters**: none
```

### 5. âœ… Shared Store vs Config Params Distinction (lines 149-157)

```python
# Format exclusive parameters (params not in inputs)
params = node_data["params"]
inputs_set = set(inputs)
exclusive_params = [p for p in params if p not in inputs_set]
```

## What Actually Remains for 16.3

### 1. ðŸ”§ Enhanced Category Detection

Current implementation uses simple string matching. Could be enhanced:
- Check module path structure (`pflow.nodes.file.*` â†’ File Operations)
- Use node class hierarchy if available
- Handle edge cases (what if a node fits multiple categories?)

### 2. ðŸ“Š More Sophisticated Size Monitoring

Current: Simple byte count warning at 10KB
Could add:
- Node count warnings (e.g., >50 nodes)
- Category count warnings (e.g., >10 categories)
- Structured metrics in logs

### 3. ðŸŽ¨ Format Polish Based on planner.md

Check `/Users/andfal/projects/pflow/docs/features/planner.md` for exact format preferences:
- Optional parameter indicators
- Default value display format
- Action-to-output mapping

### 4. ðŸ“ Optional Parameter Indicators

Currently all inputs are shown the same. From planner.md examples:
```
Reads: shared["issue_number"] (optional)
```

We don't currently distinguish optional vs required inputs.

## The Real Value Add for 16.3

Since basic functionality exists, focus on **refinement and polish**:

### 1. Better Category Names
Current categories might be too generic. Consider:
- "File System Operations" vs "File Operations"
- "Version Control" vs "Git Operations"
- "External APIs" vs "HTTP/API Operations"

### 2. Smarter Category Detection
```python
# Current: Simple string matching
if "file" in node_type or "read" in node_type or "write" in node_type:

# Could be: Multi-factor detection
def categorize_node(node_type: str, module_path: str, description: str) -> str:
    # Check module path first (most reliable)
    if "nodes.file" in module_path:
        return "File System Operations"

    # Fall back to name patterns
    # Consider description content too
```

### 3. Context Size Insights
Instead of just warning at 10KB:
```python
logger.info(
    f"context: Build complete",
    extra={
        "total_size": output_size,
        "node_count": len(processed_nodes),
        "category_count": len(categories),
        "avg_node_size": output_size / len(processed_nodes) if processed_nodes else 0
    }
)
```

### 4. Format Consistency Verification
Ensure every node follows EXACTLY the same format pattern. Currently working but could be more strict.

## Testing Considerations

Current tests already cover:
- Category grouping logic
- Basic formatting
- Parameter filtering

Additional tests for 16.3:
- Large context size warnings
- Edge cases in categorization
- Format consistency across all nodes

## Performance Notes

The current implementation is already quite efficient:
- Single pass through nodes
- No redundant operations
- Clean separation of concerns

Don't optimize what isn't slow. The real bottleneck is in the import/extraction phase (16.2), not formatting (16.3).

## Strategic Context

From `/Users/andfal/projects/pflow/.taskmaster/tasks/task_16/16-strategic-vision.md`:
- Bad context = 5x cost multiplier through retries
- Format must enable connection discovery
- Categories help LLM understand available tools

The current implementation already achieves these goals. 16.3 is about making it even better.

## My Recommendations

1. **Quick Polish Pass** (30 minutes):
   - Add node/category count to size monitoring
   - Consider renaming some categories for clarity
   - Add a comment about why we use 10KB threshold

2. **Optional Enhancements** (if time permits):
   - Implement optional parameter detection
   - Add module-path-based categorization
   - Create a category priority system (if node fits multiple)

3. **Don't Over-Engineer**:
   - Current solution works well
   - Simple pattern matching is maintainable
   - Perfect categorization isn't critical for MVP

## Files to Review

1. **Current Implementation**: `/Users/andfal/projects/pflow/src/pflow/planning/context_builder.py`
2. **Current Tests**: `/Users/andfal/projects/pflow/tests/test_planning/test_context_builder.py`
3. **Format Examples**: `/Users/andfal/projects/pflow/docs/features/planner.md` (section 6.1)
4. **Strategic Vision**: `/Users/andfal/projects/pflow/.taskmaster/tasks/task_16/16-strategic-vision.md`

## Quick Test

Run this to see current output:
```python
from pflow.registry import Registry
from pflow.planning.context_builder import build_context

registry = Registry()
context = build_context(registry.load())
print(context)
```

## The 80/20 Rule

80% of 16.3's value is already implemented:
- âœ… Categories work
- âœ… Format is clean
- âœ… Size monitoring exists
- âœ… Params are filtered

The remaining 20% is polish. Don't spend 80% of the time on it.

## Critical Warning

The current implementation passes all tests and produces clean output. Whatever you do:
1. Don't break the exclusive parameter filtering
2. Don't break the category grouping
3. Don't make the format more complex
4. Keep the simple, maintainable approach

## Actual Test Output Shows It's Working

From my manual test:
```
=== Generated Context ===
## File Operations

### copy-file
Copy a file to a new location with automatic directory creation.

**Inputs**: `source_path`, `dest_path`, `overwrite`
**Outputs**: `copied`, `error` (error)
**Parameters**: none

### delete-file
Delete a file from the filesystem with safety confirmation.

**Inputs**: `file_path`, `confirm_delete`
**Outputs**: `deleted`, `error` (error)
**Parameters**: none

[... more nodes ...]

=== Summary ===
Total length: 956 characters
Number of sections: 6
Number of nodes: 5
```

The format is clean, categories are logical, and the exclusive parameter filtering is working perfectly.

**IMPORTANT**: Acknowledge you've read this memo and are ready to begin. Do NOT start implementing until you've confirmed understanding.
