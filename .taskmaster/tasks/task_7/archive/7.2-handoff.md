# Handoff Memo: Task 7.2 - Interface Section Parsing

**TO THE IMPLEMENTING AGENT**: Read this entire memo before starting. When done, acknowledge you're ready to begin - DO NOT start implementing immediately.

## üéØ What You're Building On

You're extending the `PflowMetadataExtractor` I just created in 7.1. The foundation is solid:
- Class validation ‚úì
- Description extraction ‚úì
- Basic structure with empty lists ‚úì

Your job: Fill those empty lists by parsing the Interface section.

## üîç The ACTUAL Format You're Parsing

**Critical**: The documentation lies about elaborate formats. Here's what's REALLY in the codebase:

```python
"""
Interface:
- Reads: shared["file_path"] (required), shared["encoding"] (optional)
- Writes: shared["content"] on success, shared["error"] on failure
- Params: file_path, encoding (as fallbacks if not in shared)
- Actions: default (success), error (failure)
"""
```

**Real examples to test against**:
- `/src/pflow/nodes/file/read_file.py` (lines 24-28)
- `/src/pflow/nodes/file/write_file.py` (lines 27-32)
- `/src/pflow/nodes/file/copy_file.py` (lines 26-31)

## üí£ Critical Discoveries from 7.1

### 1. The Docstring Reality Check
I initially tested with theoretical descriptions like "Read file contents from the filesystem." The ACTUAL first lines are more detailed:
- ReadFileNode: "Read content from a file and add line numbers for display."
- WriteFileNode: "Write content to a file with automatic directory creation."

**Why this matters**: Your Interface parsing tests MUST use real node docstrings, not made-up examples.

### 2. The Code You're Extending
The extractor is at `/src/pflow/registry/metadata_extractor.py`. The method you're modifying:

```python
def extract_metadata(self, node_class: type) -> Dict[str, Any]:
    # ... validation code ...

    # Phase 3: Extract description
    docstring = inspect.getdoc(node_class)
    description = self._extract_description(docstring)

    # Return basic structure with empty lists for subtask 7.1
    return {
        'description': description,
        'inputs': [],      # YOU FILL THIS
        'outputs': [],     # YOU FILL THIS
        'params': [],      # YOU FILL THIS
        'actions': []      # YOU FILL THIS
    }
```

## üéÅ Regex Patterns That Actually Work

From the Task 7 handoff memo at `.taskmaster/tasks/task_7/7_handover.md`:

```python
INTERFACE_PATTERN = r'Interface:\s*\n((?:[ \t]*-[^\n]+\n)*)'
SHARED_KEY_PATTERN = r'shared\["([^"]+)"\]'
ACTIONS_PATTERN = r'(\w+)(?:\s*\([^)]+\))?'
```

These have been verified to work. Use them.

## ‚ö†Ô∏è Edge Cases I Discovered

1. **Some nodes have NO Interface section** - Don't crash, return empty lists
2. **Params can have parenthetical notes** - "encoding (as fallbacks if not in shared)"
3. **Actions often have descriptions** - "default (success)" - extract just "default"
4. **Multi-value lines** - "shared["key1"] (required), shared["key2"] (optional)"

## üö´ What NOT to Parse (Yet)

The handoff memo mentions you should extract just the KEY NAMES:
- From `shared["file_path"]` ‚Üí extract `"file_path"`
- From `default (success)` ‚Üí extract `"default"`
- Don't preserve the descriptions or metadata

## üß™ Testing Strategy That Works

1. **Use the existing test file**: `/tests/test_registry/test_metadata_extractor.py`
2. **Test with REAL nodes first** - The integration tests are already there
3. **Add edge case tests after** - Missing sections, malformed content, etc.

The test class `TestRealNodeIntegration` already imports real nodes. Extend it.

## üîó Performance Tip from Handoff

> "Some nodes have LONG docstrings. Don't try to parse the entire docstring with one massive regex. Instead:
> 1. Extract the Interface section first
> 2. Parse individual lines within that section
> 3. This prevents catastrophic backtracking"

## üìù Contract Changes

After 7.2, the output format changes from:
```python
{'description': 'Write content...', 'inputs': [], 'outputs': [], ...}
```

To:
```python
{
    'description': 'Write content...',
    'inputs': ['content', 'file_path', 'encoding'],
    'outputs': ['written', 'error'],
    'params': ['content', 'file_path', 'encoding', 'append'],
    'actions': ['default', 'error']
}
```

## üéØ Files You'll Touch

1. `/src/pflow/registry/metadata_extractor.py` - Add parsing logic
2. `/tests/test_registry/test_metadata_extractor.py` - Extend tests
3. Real nodes for testing:
   - `/src/pflow/nodes/file/read_file.py`
   - `/src/pflow/nodes/file/write_file.py`
   - `/src/pflow/nodes/test_node.py` (simpler Interface)

## üö® Final Critical Warning

The `.taskmaster/tasks/task_7/7_handover.md` file has detailed analysis of what went wrong in previous attempts. READ IT. It explains:
- Why the documentation is misleading
- What the actual format looks like
- Common parsing pitfalls

## üî¥ MAJOR UPDATE: Documentation Now Contains Complete Implementations!

**CRITICAL DISCOVERY**: The `/architecture/implementation-details/metadata-extraction.md` file has been updated and now contains:

1. **A complete `PflowMetadataExtractor` implementation** (lines 148-279) that already implements the Interface parsing you're supposed to do!

2. **A second `InterfaceSectionParser` class** (lines 281-386) that provides even MORE sophisticated parsing with rich metadata objects instead of simple lists.

### Two Different Output Formats Shown:

**Simple Lists (Task 7 spec):**
```python
{
    'inputs': ['file_path', 'encoding'],
    'outputs': ['content', 'error'],
    'params': ['file_path', 'encoding'],
    'actions': ['default', 'error']
}
```

**Rich Objects (InterfaceSectionParser):**
```python
{
    'inputs': {
        'file_path': {
            'description': 'file_path',
            'type': 'any',
            'required': True
        },
        'encoding': {
            'description': 'encoding',
            'type': 'any',
            'required': False
        }
    },
    # ... similar for outputs, params
}
```

### What This Means for You:

1. **Reference Implementation Available**: You can look at the complete implementation for guidance
2. **Output Format Decision**: Stick with the simple list format as specified in Task 7
3. **Don't Over-Engineer**: The `InterfaceSectionParser` is more complex than needed for MVP
4. **Use the Regex Patterns**: The implementation confirms the regex patterns I mentioned work

**YOU MUST READ**: `/architecture/implementation-details/metadata-extraction.md` (lines 136-435)
- Lines 148-279: Complete `PflowMetadataExtractor` with Interface parsing
- Lines 281-386: Alternative `InterfaceSectionParser` with rich metadata
- Lines 208-278: The exact parsing methods you need to implement

The documentation is no longer a "fantasy" - it now contains working code! But stick to the Task 7 specification for simple lists, not the rich metadata objects.

### üõçÔ∏è IMPORTANT: These Are Suggestions, Not Requirements

**The implementations in the documentation are SUGGESTIONS**. If you encounter any non-trivial ambiguities:

1. **STOP immediately**
2. **Document the ambiguity clearly**
3. **Ask the user for clarification**

Examples of ambiguities that require user input:
- Conflicting approaches between Task 7 spec and documentation implementation
- Unclear whether to parse additional metadata beyond the basic lists
- Questions about error handling or edge cases not covered in the spec
- Any architectural decisions that would affect future tasks

**Do NOT make assumptions** about which approach is "better" or "more correct". The user needs to make these decisions.

---

**Remember**: Acknowledge you've read this memo before starting implementation. Good luck!

**IMPORTANT**: The handoff memo suggests this is the complete parsing implementation. Make sure to parse ALL four fields (Reads, Writes, Params, Actions) in this subtask.
