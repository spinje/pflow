# Subtask 14.2 Handoff: Critical Integration Knowledge

**⚠️ IMPORTANT**: Do NOT begin implementing yet. Read this entire handoff and confirm you understand before starting.

## What You're Building On

### Subtask 14.1 Already Implemented These:
Looking at the modified files, 14.1 has COMPLETELY implemented the enhanced parser:

1. **Format Detection**: `_detect_interface_format()` detects enhanced vs simple format
2. **Enhanced Parsing**: `_extract_enhanced_shared_keys()` and `_extract_enhanced_params()`
3. **Structure Parsing**: `_parse_all_structures()` and `_parse_structure()` for nested dicts
4. **Normalization**: `_normalize_to_rich_format()` converts everything to consistent format
5. **Integration**: Already integrated into `extract_metadata()` - it's returning rich format!

The parser is DONE and working. Look at lines 108-114 in metadata_extractor.py:
```python
result = {
    "description": description,
    "inputs": self._normalize_to_rich_format(interface_data.get("inputs", [])),
    "outputs": self._normalize_to_rich_format(interface_data.get("outputs", [])),
    "params": self._normalize_to_rich_format(interface_data.get("params", [])),
    "actions": interface_data.get("actions", []),  # Actions remain as simple list
}
```

## Your ACTUAL Scope for 14.2

Since the parser integration is already done, your focus shifts to:

### 1. Context Builder Integration (Primary Focus)
The context builder (`src/pflow/planning/context_builder.py`) currently shows metadata like this:
```
**Inputs**: file_path, encoding
**Outputs**: content, error
**Parameters**: None (inputs serve as params)
```

You need to enhance `_format_node_section()` to show the new type information:
```
**Inputs**: file_path (str), encoding (str)
**Outputs**: content (str), error (str)
**Parameters**: None (inputs serve as params)
```

And for complex structures, show navigable paths:
```
**Outputs**: issue_data (dict) - Access via: issue_data.number, issue_data.user.login
```

### 2. Exclusive Params Pattern (Critical)
The context builder MUST implement the exclusive params pattern. Look at the test file changes - params that are also inputs should NOT be shown as parameters. This is already partially implemented but needs to work with the new format.

Current code probably does something like:
```python
exclusive_params = [p for p in params if p not in inputs]
```

With rich format, you need:
```python
input_keys = {item["key"] for item in metadata["inputs"]}
exclusive_params = [p for p in metadata["params"] if p["key"] not in input_keys]
```

### 3. Storage Format Verification
The metadata is ALREADY being stored in the new format (see the test updates). But verify:
- Registry storage works with the new format
- JSON serialization handles the nested structures
- No issues with the structure fields containing nested dicts

## Critical Files You Must Study

1. **Context Builder**: `src/pflow/planning/context_builder.py`
   - Focus on `_format_node_section()` method
   - This is where type display happens
   - Keep changes MINIMAL as instructed

2. **Updated Tests**: `tests/test_registry/test_metadata_extractor.py`
   - ALL tests now expect rich format (see lines 29-35, 64-76, etc.)
   - Shows exact structure of the new metadata format
   - Your context builder must handle this format

3. **Knowledge Base Addition**: `.taskmaster/knowledge/patterns.md`
   - Lines 929-961 show the "Format Detection with Graceful Enhancement" pattern
   - This is what 14.1 implemented - study it to understand the approach

## The 50KB Context Limit Challenge

The task mentions considering the 50KB limit when formatting structures. For deeply nested structures:

1. **Abbreviated Display**: Show only commonly used paths
   ```
   **Outputs**: issue_data (dict) - Common paths: .number, .title, .user.login, .labels[].name
   ```

2. **Depth Limiting**: Don't show structures beyond 2-3 levels
3. **Smart Truncation**: Focus on fields with descriptions (more likely to be important)

## Integration Points You're Updating

### 1. Node Import Path
The context builder imports nodes dynamically. With new metadata format, ensure:
- It handles nodes that haven't been migrated yet (type="any")
- Graceful handling if structure parsing failed
- Display makes sense for both simple and complex types

### 2. Category Grouping
Nodes are grouped by category. Make sure your formatting works consistently across:
- File Operations
- AI/LLM Operations
- Development Tools
- Platform Integrations

### 3. The `_format_field()` Helper
There's likely a helper that formats individual fields. This needs to handle:
- Simple types: `key (type)`
- Complex types: `key (type) - structure info`
- Missing types: `key` (backward compatibility)

## Testing Your Integration

The existing tests for context builder need to be updated to expect type information. Key test scenarios:

1. **Backward Compatibility**: Nodes without types still display correctly
2. **Type Display**: Types show in parentheses after keys
3. **Structure Hints**: Complex types show navigation hints
4. **Exclusive Params**: Params that are inputs don't show
5. **Performance**: Large structures don't blow up the context

## What Success Looks Like for 14.2

When you're done:
1. Context builder shows types for all Interface components
2. Complex structures have navigation hints
3. Exclusive params pattern is properly implemented
4. All existing tests pass with updated expectations
5. The 50KB limit is respected even with structure info
6. NO major redesigns - minimal changes only

## Common Pitfalls to Avoid

1. **Don't Reimplement the Parser** - It's already done in 14.1!
2. **Don't Break Backward Compatibility** - Nodes without types must still work
3. **Don't Over-Engineer Structure Display** - Simple paths are enough
4. **Don't Forget Exclusive Params** - Critical pattern from knowledge base
5. **Don't Make Major Redesigns** - Task explicitly says minimal changes

## Hidden Context from My Analysis

### The Two-Context Future
Task 15 creates different contexts, and the ambiguities mentioned a two-file approach. Your minimal changes should be forward-compatible with this future split. Don't implement the split, but don't make changes that would prevent it.

### Planner Integration
Task 17 (the planner) will consume your formatted output. Think about what an LLM needs:
- Clear type information for understanding data
- Path examples for complex structures
- Descriptions when available
- Clean, readable format

### Why Types Matter More Than You Think
From the research files: The planner needs to know if `content` is a string to display or a dict to process. Without types, it generates wrong handling code. Your clear type display directly impacts planner success rate.

## Performance Considerations

- The context builder runs during planning (hot path)
- It processes many nodes (all registered nodes)
- Format once, read many times
- Keep string operations efficient
- Pre-compile any regex patterns

## Your Deliverables

1. **Updated `_format_node_section()`** with type display
2. **Exclusive params filtering** that works with rich format
3. **Structure navigation hints** for complex types
4. **Updated tests** expecting the new format
5. **Verification** that storage/serialization works

## Final Critical Reminder

You're the bridge between the rich metadata that 14.1 extracts and the planner that needs to understand it. The parser gives you:
```python
{"key": "issue_data", "type": "dict", "description": "GitHub issue", "structure": {...}}
```

You need to present this as:
```
issue_data (dict) - GitHub issue - Navigate: .number, .user.login, .labels[].name
```

Clear, concise, helpful. That's your mission.

---

**Remember**:
- Read the project context (`.taskmaster/tasks/task_14/project-context.md`) for domain understanding
- The parser is ALREADY DONE - don't touch it
- Focus on context builder display and exclusive params
- Keep changes minimal as instructed

Good luck! Dont begin yet, read the project context and any highly relevant files then say that you are ready to begin.
