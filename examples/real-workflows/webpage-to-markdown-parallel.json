{
  "inputs": {
    "url": {
      "type": "string",
      "required": true,
      "description": "Webpage URL to scrape"
    },
    "output_dir": {
      "type": "string",
      "required": true,
      "description": "Directory to save markdown and images"
    }
  },
  "nodes": [
    {
      "id": "fetch-html",
      "type": "http",
      "purpose": "Fetch raw HTML from the webpage",
      "params": {
        "url": "${url}"
      }
    },
    {
      "id": "split-html",
      "type": "shell",
      "purpose": "Split HTML into logical sections for parallel processing",
      "params": {
        "stdin": "${fetch-html.response}",
        "command": "python3 -c \"import sys,json,re; html=sys.stdin.read(); article=re.search(r'<article[^>]*>(.*?)</article>',html,re.DOTALL|re.IGNORECASE); content=article.group(1) if article else re.search(r'<body[^>]*>(.*?)</body>',html,re.DOTALL|re.IGNORECASE).group(1) if re.search(r'<body[^>]*>(.*?)</body>',html,re.DOTALL|re.IGNORECASE) else html; parts=re.split(r'(?=<h[23][^>]*>)',content,flags=re.IGNORECASE); sections=[p.strip() for p in parts if len(p.strip())>100]; sections=sections if sections else [content]; print(json.dumps(sections))\""
      }
    },
    {
      "id": "convert-sections",
      "type": "llm",
      "purpose": "Convert each HTML section to markdown in parallel",
      "batch": {
        "items": "${split-html.stdout}",
        "parallel": true,
        "max_concurrent": 50
      },
      "params": {
        "prompt": "Convert this HTML to clean markdown. Ignore any scripts, CSS, navigation, ads, or non-content elements. Preserve all image references using markdown syntax ![alt](url). Keep original image URLs exactly as they appear.\n\nHTML:\n${item}",
        "temperature": 0.1,
        "model": "gemini-3-flash-preview"
      }
    },
    {
      "id": "extract-title",
      "type": "shell",
      "purpose": "Extract page title from HTML",
      "params": {
        "stdin": "${fetch-html.response}",
        "command": "python3 -c \"import sys,re,html; h=sys.stdin.read(); m=re.search(r'<h1[^>]*>([^<]+)</h1>',h,re.I) or re.search(r'<title>([^|<]+)',h,re.I); print(html.unescape(m.group(1).strip()) if m else '')\""
      }
    },
    {
      "id": "stitch-markdown",
      "type": "shell",
      "purpose": "Combine markdown sections and ensure title heading exists",
      "params": {
        "stdin": "${convert-sections.results}",
        "command": "title='${extract-title.stdout}'; content=$(jq -r '.[] | .response'); if [ -n \"$title\" ]; then echo \"# $title\"; echo; fi; echo \"$content\""
      }
    },
    {
      "id": "extract-content-images",
      "type": "shell",
      "purpose": "Extract content image URLs using regex, filtering out ads and tracking",
      "params": {
        "stdin": "${stitch-markdown.stdout}",
        "command": "grep -oE '!\\[[^]]*\\]\\([^)]+\\)' | grep -oE '\\([^)]+\\)' | tr -d '()' | grep -v -E '(doubleclick|pixel|tracker|analytics|beacon|ads)' | jq -R -s 'split(\"\\n\") | map(select(length > 0))'"
      }
    },
    {
      "id": "download-and-rewrite",
      "type": "shell",
      "purpose": "Download images and rewrite markdown with local paths",
      "params": {
        "stdin": "${stitch-markdown.stdout}",
        "command": "mkdir -p \"${output_dir}/images\" && markdown=$(cat) && for original_url in $(echo '${extract-content-images.stdout}' | jq -r '.[]' 2>/dev/null); do if [[ \"$original_url\" == *\"/_next/image\"* ]]; then download_url=$(echo \"$original_url\" | sed 's/.*url=\\([^&]*\\).*/\\1/' | python3 -c 'import sys,urllib.parse;print(urllib.parse.unquote(sys.stdin.read().strip()))'); else download_url=\"$original_url\"; fi; filename=$(basename \"$download_url\" | cut -d'?' -f1); curl -sL --max-time 30 \"$download_url\" -o \"${output_dir}/images/$filename\" 2>/dev/null && markdown=$(echo \"$markdown\" | sed \"s|$original_url|./images/$filename|g\"); done && echo \"$markdown\"",
        "timeout": 120
      }
    },
    {
      "id": "save-markdown",
      "type": "write-file",
      "purpose": "Save the final markdown file",
      "params": {
        "file_path": "${output_dir}/article.md",
        "content": "${download-and-rewrite.stdout}"
      }
    }
  ],
  "edges": [
    {
      "from": "fetch-html",
      "to": "extract-title"
    },
    {
      "from": "extract-title",
      "to": "split-html"
    },
    {
      "from": "split-html",
      "to": "convert-sections"
    },
    {
      "from": "convert-sections",
      "to": "stitch-markdown"
    },
    {
      "from": "stitch-markdown",
      "to": "extract-content-images"
    },
    {
      "from": "extract-content-images",
      "to": "download-and-rewrite"
    },
    {
      "from": "download-and-rewrite",
      "to": "save-markdown"
    }
  ],
  "outputs": {
    "markdown_path": {
      "source": "${output_dir}/article.md",
      "description": "Path to the saved markdown file"
    }
  }
}
